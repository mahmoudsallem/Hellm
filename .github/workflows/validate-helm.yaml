name: Validate Helm Charts

on:
  push:
    branches: [dev]


jobs:
  validate-structure:
    runs-on: ubuntu-latest
    name: Validate Chart Structure

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Dev Backend Chart
        run: |
          echo "=== Validating Dev Backend Chart ==="

          # Check values.yaml
          if [ -f "helm/Dev/backend/values.yaml" ]; then
            echo "✅ helm/Dev/backend/values.yaml exists"
          else
            echo "❌ helm/Dev/backend/values.yaml is missing"
            exit 1
          fi

          # Check Chart.yaml
          if [ -f "helm/Dev/backend/Chart.yaml" ]; then
            echo "✅ helm/Dev/backend/Chart.yaml exists"
          else
            echo "❌ helm/Dev/backend/Chart.yaml is missing"
            exit 1
          fi

          # Check templates folder
          if [ -d "helm/Dev/backend/templates" ]; then
            echo "✅ helm/Dev/backend/templates/ exists"
          else
            echo "❌ helm/Dev/backend/templates/ is missing"
            exit 1
          fi

          # Check required templates
          for template in deployment.yaml service.yaml secret.yaml configmap.yaml; do
            if [ -f "helm/Dev/backend/templates/$template" ]; then
              echo "✅ helm/Dev/backend/templates/$template exists"
            else
              echo "❌ helm/Dev/backend/templates/$template is missing"
              exit 1
            fi
          done

      - name: Validate Dev DB Chart
        run: |
          echo "=== Validating Dev DB Chart ==="

          # Check values.yaml
          if [ -f "helm/Dev/db/values.yaml" ]; then
            echo "✅ helm/Dev/db/values.yaml exists"
          else
            echo "❌ helm/Dev/db/values.yaml is missing"
            exit 1
          fi

          # Check Chart.yaml
          if [ -f "helm/Dev/db/Chart.yaml" ]; then
            echo "✅ helm/Dev/db/Chart.yaml exists"
          else
            echo "❌ helm/Dev/db/Chart.yaml is missing"
            exit 1
          fi

          # Check templates folder
          if [ -d "helm/Dev/db/templates" ]; then
            echo "✅ helm/Dev/db/templates/ exists"
          else
            echo "❌ helm/Dev/db/templates/ is missing"
            exit 1
          fi

          # Check required templates
          for template in postgres-statefulset.yaml postgres-service.yaml secret.yaml configmap.yaml; do
            if [ -f "helm/Dev/db/templates/$template" ]; then
              echo "✅ helm/Dev/db/templates/$template exists"
            else
              echo "❌ helm/Dev/db/templates/$template is missing"
              exit 1
            fi
          done

      - name: Validate Dev Frontend Chart
        run: |
          echo "=== Validating Dev Frontend Chart ==="

          # Check values.yaml
          if [ -f "helm/Dev/frontend/values.yaml" ]; then
            echo "✅ helm/Dev/frontend/values.yaml exists"
          else
            echo "❌ helm/Dev/frontend/values.yaml is missing"
            exit 1
          fi

          # Check Chart.yaml
          if [ -f "helm/Dev/frontend/Chart.yaml" ]; then
            echo "✅ helm/Dev/frontend/Chart.yaml exists"
          else
            echo "❌ helm/Dev/frontend/Chart.yaml is missing"
            exit 1
          fi

          # Check templates folder
          if [ -d "helm/Dev/frontend/templates" ]; then
            echo "✅ helm/Dev/frontend/templates/ exists"
          else
            echo "❌ helm/Dev/frontend/templates/ is missing"
            exit 1
          fi

          # Check required templates
          for template in deployment.yaml service.yaml ingress.yaml; do
            if [ -f "helm/Dev/frontend/templates/$template" ]; then
              echo "✅ helm/Dev/frontend/templates/$template exists"
            else
              echo "❌ helm/Dev/frontend/templates/$template is missing"
              exit 1
            fi
          done

      - name: Validate Prod Charts
        run: |
          echo "=== Validating Prod Charts ==="

          for chart in backend db frontend; do
            echo "--- Checking Prod/$chart ---"

            if [ -f "helm/Prod/$chart/values.yaml" ]; then
              echo "✅ helm/Prod/$chart/values.yaml exists"
            else
              echo "❌ helm/Prod/$chart/values.yaml is missing"
              exit 1
            fi

            if [ -f "helm/Prod/$chart/Chart.yaml" ]; then
              echo "✅ helm/Prod/$chart/Chart.yaml exists"
            else
              echo "❌ helm/Prod/$chart/Chart.yaml is missing"
              exit 1
            fi

            if [ -d "helm/Prod/$chart/templates" ]; then
              echo "✅ helm/Prod/$chart/templates/ exists"
            else
              echo "❌ helm/Prod/$chart/templates/ is missing"
              exit 1
            fi
          done

      - name: Validate values.yaml syntax
        run: |
          echo "=== Validating YAML Syntax ==="

          # Install yq for YAML validation
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Validate all values.yaml files
          for file in helm/Dev/*/values.yaml helm/Prod/*/values.yaml; do
            if yq eval '.' "$file" > /dev/null 2>&1; then
              echo "✅ $file is valid YAML"
            else
              echo "❌ $file has invalid YAML syntax"
              exit 1
            fi
          done

  helm-lint:
    runs-on: ubuntu-latest
    name: Helm Lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Lint Dev Charts
        run: |
          echo "=== Linting Dev Charts ==="

          for chart in backend db frontend; do
            echo "--- Linting Dev/$chart ---"
            helm lint helm/Dev/$chart || echo "⚠️ Lint warnings for Dev/$chart"
          done

      - name: Lint Prod Charts
        run: |
          echo "=== Linting Prod Charts ==="

          for chart in backend db frontend; do
            echo "--- Linting Prod/$chart ---"
            helm lint helm/Prod/$chart || echo "⚠️ Lint warnings for Prod/$chart"
          done

  helm-template:
    runs-on: ubuntu-latest
    name: Helm Template Validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Template Dev Charts
        run: |
          echo "=== Templating Dev Charts ==="

          for chart in backend db frontend; do
            echo "--- Templating Dev/$chart ---"
            if helm template test helm/Dev/$chart > /dev/null 2>&1; then
              echo "✅ helm/Dev/$chart templates successfully"
            else
              echo "❌ helm/Dev/$chart template failed"
              helm template test helm/Dev/$chart
              exit 1
            fi
          done

      - name: Template Prod Charts
        run: |
          echo "=== Templating Prod Charts ==="

          for chart in backend db frontend; do
            echo "--- Templating Prod/$chart ---"
            if helm template test helm/Prod/$chart > /dev/null 2>&1; then
              echo "✅ helm/Prod/$chart templates successfully"
            else
              echo "❌ helm/Prod/$chart template failed"
              helm template test helm/Prod/$chart
              exit 1
            fi
          done
