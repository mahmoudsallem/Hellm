name: Validate Main Branch PR

on:
  pull_request:
    branches: [main]

jobs:
  validate-files:
    runs-on: ubuntu-latest
    name: Validate Files Exist

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Helm Chart Structure
        run: |
          echo "=== Validating Helm Chart Structure ==="

          ERRORS=0

          # Required charts
          CHARTS=("Dev/backend" "Dev/db" "Dev/frontend" "Prod/backend" "Prod/db" "Prod/frontend")

          for chart in "${CHARTS[@]}"; do
            echo "--- Checking helm/$chart ---"

            # Check values.yaml
            if [ -f "helm/$chart/values.yaml" ]; then
              echo "✅ helm/$chart/values.yaml"
            else
              echo "❌ helm/$chart/values.yaml is MISSING"
              ERRORS=$((ERRORS+1))
            fi

            # Check Chart.yaml
            if [ -f "helm/$chart/Chart.yaml" ]; then
              echo "✅ helm/$chart/Chart.yaml"
            else
              echo "❌ helm/$chart/Chart.yaml is MISSING"
              ERRORS=$((ERRORS+1))
            fi

            # Check templates folder
            if [ -d "helm/$chart/templates" ]; then
              echo "✅ helm/$chart/templates/"
            else
              echo "❌ helm/$chart/templates/ is MISSING"
              ERRORS=$((ERRORS+1))
            fi

            # Check _helpers.tpl
            if [ -f "helm/$chart/templates/_helpers.tpl" ]; then
              echo "✅ helm/$chart/templates/_helpers.tpl"
            else
              echo "❌ helm/$chart/templates/_helpers.tpl is MISSING"
              ERRORS=$((ERRORS+1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "❌ Found $ERRORS missing files"
            exit 1
          fi

          echo ""
          echo "✅ All required files exist"

      - name: Validate K8s Manifests Exist
        run: |
          echo "=== Validating K8s Manifests ==="

          ERRORS=0

          # Check k8s folder
          for folder in backend db frontend; do
            if [ -d "k8s/$folder" ]; then
              echo "✅ k8s/$folder/"
            else
              echo "❌ k8s/$folder/ is MISSING"
              ERRORS=$((ERRORS+1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

          echo "✅ All K8s folders exist"

  validate-docker-images:
    runs-on: ubuntu-latest
    name: Validate Docker Images

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract and Validate Docker Images
        run: |
          echo "=== Extracting Docker Images from values.yaml ==="

          ERRORS=0

          # Function to check if Docker image exists
          check_image() {
            local image=$1
            local repo=$(echo $image | cut -d: -f1)
            local tag=$(echo $image | cut -d: -f2)

            # Handle images without tag
            if [ "$repo" == "$tag" ]; then
              tag="latest"
            fi

            echo -n "Checking $image ... "

            # Check Docker Hub API
            if [[ "$repo" == *"/"* ]]; then
              # User repository (e.g., mostafakassas55/nti_backend)
              response=$(curl -s "https://hub.docker.com/v2/repositories/$repo/tags/$tag" 2>/dev/null)
            else
              # Official image (e.g., postgres, nginx)
              response=$(curl -s "https://hub.docker.com/v2/repositories/library/$repo/tags/$tag" 2>/dev/null)
            fi

            if echo "$response" | grep -q '"name"'; then
              echo "✅ exists"
              return 0
            else
              echo "❌ NOT FOUND"
              return 1
            fi
          }

          # Extract images from values.yaml files
          echo ""
          echo "--- Checking Backend Images ---"

          # Backend image
          BACKEND_REPO=$(grep -A2 "^image:" helm/Dev/backend/values.yaml | grep "repository:" | awk '{print $2}' | tr -d '"')
          BACKEND_TAG=$(grep -A2 "^image:" helm/Dev/backend/values.yaml | grep "tag:" | awk '{print $2}' | tr -d '"')
          if [ -n "$BACKEND_REPO" ] && [ -n "$BACKEND_TAG" ]; then
            if ! check_image "$BACKEND_REPO:$BACKEND_TAG"; then
              ERRORS=$((ERRORS+1))
            fi
          fi

          echo ""
          echo "--- Checking Frontend Images ---"

          # Frontend image
          FRONTEND_REPO=$(grep -A2 "^image:" helm/Dev/frontend/values.yaml | grep "repository:" | awk '{print $2}' | tr -d '"')
          FRONTEND_TAG=$(grep -A2 "^image:" helm/Dev/frontend/values.yaml | grep "tag:" | awk '{print $2}' | tr -d '"')
          if [ -n "$FRONTEND_REPO" ] && [ -n "$FRONTEND_TAG" ]; then
            if ! check_image "$FRONTEND_REPO:$FRONTEND_TAG"; then
              ERRORS=$((ERRORS+1))
            fi
          fi

          echo ""
          echo "--- Checking Database Images ---"

          # Postgres image
          POSTGRES_REPO=$(grep -A3 "image:" helm/Dev/db/values.yaml | grep "repository:" | head -1 | awk '{print $2}' | tr -d '"')
          POSTGRES_TAG=$(grep -A3 "image:" helm/Dev/db/values.yaml | grep "tag:" | head -1 | awk '{print $2}' | tr -d '"')
          if [ -n "$POSTGRES_REPO" ] && [ -n "$POSTGRES_TAG" ]; then
            if ! check_image "$POSTGRES_REPO:$POSTGRES_TAG"; then
              ERRORS=$((ERRORS+1))
            fi
          fi

          echo ""
          if [ $ERRORS -gt 0 ]; then
            echo "❌ Found $ERRORS invalid Docker images"
            exit 1
          fi

          echo "✅ All Docker images are valid and accessible"

  helm-validation:
    runs-on: ubuntu-latest
    name: Helm Lint and Template

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Helm Lint
        run: |
          echo "=== Helm Lint ==="

          ERRORS=0

          for env in Dev Prod; do
            for chart in backend db frontend; do
              echo "--- Linting $env/$chart ---"
              if ! helm lint helm/$env/$chart; then
                ERRORS=$((ERRORS+1))
              fi
            done
          done

          if [ $ERRORS -gt 0 ]; then
            echo "❌ Helm lint failed for $ERRORS charts"
            exit 1
          fi

          echo "✅ All charts passed lint"

      - name: Helm Template
        run: |
          echo "=== Helm Template Validation ==="

          ERRORS=0

          for env in Dev Prod; do
            for chart in backend db frontend; do
              echo "--- Templating $env/$chart ---"
              if ! helm template test helm/$env/$chart > /dev/null 2>&1; then
                echo "❌ helm/$env/$chart template failed"
                helm template test helm/$env/$chart
                ERRORS=$((ERRORS+1))
              else
                echo "✅ helm/$env/$chart"
              fi
            done
          done

          if [ $ERRORS -gt 0 ]; then
            echo "❌ Template validation failed for $ERRORS charts"
            exit 1
          fi

          echo "✅ All charts template successfully"
