name: Validate Main Branch PR

on:
  pull_request:
    branches: [main]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  HELM_VERSION: v3.13.0

jobs:
  # ============================================================================
  # Stage 1: Validate Docker Images Exist in Dev
  # ============================================================================
  validate-docker-images:
    runs-on: ubuntu-latest
    name: Validate Dev Docker Images

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Check Docker Images Exist
        run: |
          echo "=== Validating Dev Docker Images ==="
          ERRORS=0

          check_image() {
            local repo=$1
            local tag=$2
            local full_image="$repo:$tag"

            echo -n "  Checking $full_image ... "

            if [[ "$repo" == *"/"* ]]; then
              api_url="https://hub.docker.com/v2/repositories/$repo/tags/$tag"
            else
              api_url="https://hub.docker.com/v2/repositories/library/$repo/tags/$tag"
            fi

            response=$(curl -s "$api_url")
            if echo "$response" | grep -q '"name"'; then
              echo "✅ exists"
              return 0
            else
              echo "❌ NOT FOUND"
              return 1
            fi
          }

          # Check Backend
          echo ""
          echo "--- Backend ---"
          REPO=$(yq '.image.repository' helm/Dev/backend/values.yaml)
          TAG=$(yq '.image.tag' helm/Dev/backend/values.yaml)
          if ! check_image "$REPO" "$TAG"; then
            ERRORS=$((ERRORS+1))
          fi

          # Check Frontend
          echo ""
          echo "--- Frontend ---"
          REPO=$(yq '.image.repository' helm/Dev/frontend/values.yaml)
          TAG=$(yq '.image.tag' helm/Dev/frontend/values.yaml)
          if ! check_image "$REPO" "$TAG"; then
            ERRORS=$((ERRORS+1))
          fi

          # Check Database
          echo ""
          echo "--- Database ---"
          REPO=$(yq '.image.repository' helm/Dev/db/values.yaml)
          TAG=$(yq '.image.tag' helm/Dev/db/values.yaml)
          if ! check_image "$REPO" "$TAG"; then
            ERRORS=$((ERRORS+1))
          fi

          echo ""
          if [ $ERRORS -gt 0 ]; then
            echo "❌ Found $ERRORS invalid Docker images"
            exit 1
          fi
          echo "✅ All Dev Docker images are valid"

  # ============================================================================
  # Stage 2: Sync Image Tags from Dev to Prod
  # ============================================================================
  sync-prod-image-tags:
    runs-on: ubuntu-latest
    name: Sync Dev Tags to Prod
    needs: [validate-docker-images]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Copy Image Tags from Dev to Prod
        run: |
          echo "=== Syncing Image Tags from Dev to Prod ==="

          CHANGES=0

          for chart in backend frontend; do
            echo ""
            echo "--- Syncing $chart ---"

            DEV_TAG=$(yq '.image.tag' helm/Dev/$chart/values.yaml)
            PROD_TAG=$(yq '.image.tag' helm/Prod/$chart/values.yaml)

            echo "  Dev tag:  $DEV_TAG"
            echo "  Prod tag: $PROD_TAG"

            if [ "$DEV_TAG" != "$PROD_TAG" ]; then
              yq -i ".image.tag = $DEV_TAG" helm/Prod/$chart/values.yaml
              echo "  ✅ Updated Prod $chart tag to $DEV_TAG"
              CHANGES=$((CHANGES+1))
            else
              echo "  Tags already match"
            fi
          done

          echo ""
          if [ $CHANGES -gt 0 ]; then
            echo "=== $CHANGES tags updated ==="
          else
            echo "=== No changes needed ==="
          fi

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet; then
            echo "No changes to commit - Prod tags already match Dev"
          else
            git add helm/Prod/backend/values.yaml helm/Prod/frontend/values.yaml
            git commit -m "chore: Sync Prod image tags from Dev

            Automatically updated Prod environment image tags to match Dev.

            Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
            git push
            echo "✅ Changes committed and pushed"
          fi

  # ============================================================================
  # Stage 3: Helm Validation
  # ============================================================================
  helm-validation:
    runs-on: ubuntu-latest
    name: Helm Lint & Template
    needs: [sync-prod-image-tags]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Helm Lint
        run: |
          echo "=== Helm Lint ==="
          ERRORS=0

          for env in Dev Prod; do
            for chart in backend db frontend; do
              echo "--- Linting $env/$chart ---"
              if ! helm lint helm/$env/$chart --strict; then
                ERRORS=$((ERRORS+1))
              fi
            done
          done

          if [ $ERRORS -gt 0 ]; then
            echo "❌ Helm lint failed for $ERRORS charts"
            exit 1
          fi
          echo "✅ All charts passed lint"

      - name: Helm Template
        run: |
          echo "=== Helm Template Validation ==="
          ERRORS=0

          for env in Dev Prod; do
            for chart in backend db frontend; do
              echo "--- Templating $env/$chart ---"
              if ! helm template test helm/$env/$chart > /dev/null 2>&1; then
                echo "❌ helm/$env/$chart template failed"
                helm template test helm/$env/$chart
                ERRORS=$((ERRORS+1))
              else
                echo "✅ helm/$env/$chart"
              fi
            done
          done

          if [ $ERRORS -gt 0 ]; then
            echo "❌ Template validation failed for $ERRORS charts"
            exit 1
          fi
          echo "✅ All charts template successfully"

  # ============================================================================
  # Final: Summary
  # ============================================================================
  pr-ready:
    runs-on: ubuntu-latest
    name: PR Ready
    needs: [validate-docker-images, sync-prod-image-tags, helm-validation]
    if: success()

    steps:
      - name: PR Validation Passed
        run: |
          echo "============================================"
          echo "  ✅ PR validation passed!"
          echo "============================================"
          echo ""
          echo "  ✓ Dev Docker images verified"
          echo "  ✓ Prod image tags synced from Dev"
          echo "  ✓ Helm lint passed"
          echo "  ✓ Helm template validated"
          echo ""
          echo "  Ready to merge to main branch"
