name: Validate Main Branch PR

on:
  pull_request:
    branches: [main]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  HELM_VERSION: v3.13.0

jobs:
  # ============================================================================
  # Stage 1: Validate Docker Images Exist in Dev
  # ============================================================================
  validate-docker-images:
    runs-on: ubuntu-latest
    name: Validate Dev Docker Images
    environment: ECR_REPOSITORY

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Check ECR Images Exist
        run: |
          echo "=== Validating Dev Docker Images ==="
          ERRORS=0

          check_ecr_image() {
            local repo=$1
            local tag=$2

            echo -n "  Checking $repo:$tag ... "

            # Extract ECR repository name from full URI
            # e.g., 288378107043.dkr.ecr.us-east-1.amazonaws.com/final/app -> final/app
            if [[ "$repo" == *".ecr."* ]]; then
              ecr_repo=$(echo "$repo" | sed 's|.*\.com/||')
              if aws ecr describe-images --repository-name "$ecr_repo" --image-ids imageTag="$tag" > /dev/null 2>&1; then
                echo "✅ exists"
                return 0
              else
                echo "❌ NOT FOUND"
                return 1
              fi
            else
              # Docker Hub fallback for non-ECR images (e.g., postgres)
              if [[ "$repo" == *"/"* ]]; then
                api_url="https://hub.docker.com/v2/repositories/$repo/tags/$tag"
              else
                api_url="https://hub.docker.com/v2/repositories/library/$repo/tags/$tag"
              fi
              response=$(curl -s "$api_url")
              if echo "$response" | grep -q '"name"'; then
                echo "✅ exists"
                return 0
              else
                echo "❌ NOT FOUND"
                return 1
              fi
            fi
          }

          # Check Backend
          echo ""
          echo "--- Backend ---"
          REPO=$(yq '.image.repository' helm/Dev/backend/values.yaml)
          TAG=$(yq '.image.tag' helm/Dev/backend/values.yaml)
          if ! check_ecr_image "$REPO" "$TAG"; then
            ERRORS=$((ERRORS+1))
          fi

          # Check Frontend
          echo ""
          echo "--- Frontend ---"
          REPO=$(yq '.image.repository' helm/Dev/frontend/values.yaml)
          TAG=$(yq '.image.tag' helm/Dev/frontend/values.yaml)
          if ! check_ecr_image "$REPO" "$TAG"; then
            ERRORS=$((ERRORS+1))
          fi

          # Check Database (uses postgres.image path - Docker Hub)
          echo ""
          echo "--- Database ---"
          REPO=$(yq '.postgres.image.repository' helm/Dev/db/values.yaml)
          TAG=$(yq '.postgres.image.tag' helm/Dev/db/values.yaml)
          if ! check_ecr_image "$REPO" "$TAG"; then
            ERRORS=$((ERRORS+1))
          fi

          echo ""
          if [ $ERRORS -gt 0 ]; then
            echo "❌ Found $ERRORS invalid Docker images"
            exit 1
          fi
          echo "✅ All Dev Docker images are valid"

  # ============================================================================
  # Stage 2: Helm Validation
  # ============================================================================
  helm-validation:
    runs-on: ubuntu-latest
    name: Helm Lint & Template
    needs: [validate-docker-images]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Helm Lint
        run: |
          echo "=== Helm Lint ==="
          ERRORS=0

          for env in Dev Prod; do
            for chart in backend db frontend; do
              echo "--- Linting $env/$chart ---"
              if ! helm lint helm/$env/$chart --strict; then
                ERRORS=$((ERRORS+1))
              fi
            done
          done

          if [ $ERRORS -gt 0 ]; then
            echo "❌ Helm lint failed for $ERRORS charts"
            exit 1
          fi
          echo "✅ All charts passed lint"

      - name: Helm Template
        run: |
          echo "=== Helm Template Validation ==="
          ERRORS=0

          for env in Dev Prod; do
            for chart in backend db frontend; do
              echo "--- Templating $env/$chart ---"
              if ! helm template test helm/$env/$chart > /dev/null 2>&1; then
                echo "❌ helm/$env/$chart template failed"
                helm template test helm/$env/$chart
                ERRORS=$((ERRORS+1))
              else
                echo "✅ helm/$env/$chart"
              fi
            done
          done

          if [ $ERRORS -gt 0 ]; then
            echo "❌ Template validation failed for $ERRORS charts"
            exit 1
          fi
          echo "✅ All charts template successfully"

  # ============================================================================
  # Final: Summary
  # ============================================================================
  pr-ready:
    runs-on: ubuntu-latest
    name: PR Ready
    needs: [validate-docker-images, helm-validation]
    if: success()

    steps:
      - name: PR Validation Passed
        run: |
          echo "============================================"
          echo "  ✅ PR validation passed!"
          echo "============================================"
          echo ""
          echo "  ✓ Dev Docker images verified"
          echo "  ✓ Helm lint passed"
          echo "  ✓ Helm template validated"
          echo ""
          echo "  Ready to merge to main branch"
